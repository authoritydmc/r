{% extends "base.html" %}
{% block title %}System Info & Config - URL Shortener/Redirector{% endblock %}

{% block content %}
<div class="flex items-center justify-center min-h-[calc(100vh-160px)]">
  <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-8 w-full max-w-2xl text-center">
    <h1 class="text-2xl font-bold text-blue-700 dark:text-blue-200 mb-4 flex items-center gap-2"><i class="fa-solid fa-server"></i> System Info & Config</h1>

    <div class="text-gray-700 dark:text-gray-200 space-y-2 mb-6">
      <p><strong>Version:</strong> <span id="version-string">{{ version }}</span>
        <span id="version-status-icon" class="inline-block align-middle ml-1" title="Checking version..."><i class="fa-solid fa-spinner fa-spin"></i></span>
      </p>
      <p><strong>Commit Count:</strong> {{ commit_count }}</p>
      <p><strong>Commit Hash:</strong> {{ commit_hash }}</p>
      <p><strong>Commit Date:</strong> {{ commit_date }}</p>
    </div>

    <div class="mb-6">
      <h2 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-2">Accessible URLs</h2>
      <ul class="list-disc list-inside text-left text-gray-600 dark:text-gray-300">
        {% for url in urls %}
          <li class="flex items-center gap-2 mb-1">
            <a href="{{ url }}" class="text-blue-500 dark:text-blue-300 hover:underline" target="_blank">{{ url }}</a>
            <button onclick="copyToClipboard('{{ url }}')" class="ml-1 text-gray-500 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" title="Copy URL"><i class="fa-regular fa-copy"></i></button>
            <a href="{{ url }}" target="_blank" class="ml-1 text-gray-500 dark:text-gray-300 hover:text-blue-600 dark:hover:text-blue-400" title="Open in new tab"><i class="fa-solid fa-arrow-up-right-from-square"></i></a>
          </li>
        {% endfor %}
      </ul>
      <div class="text-xs text-gray-400 dark:text-gray-500 mt-2">You can copy or open any URL above with one click.</div>
    </div>

    <div class="mb-6 text-left">
      <h2 class="text-lg font-semibold text-blue-600 dark:text-blue-400 mb-2 flex items-center gap-2"><i class="fa-solid fa-gear"></i> Redirector Config</h2>
      {% if config_update_success %}
        <div class="bg-green-100 border border-green-300 text-green-800 px-4 py-2 rounded mb-4">{{ config_update_success }}</div>
      {% endif %}
      {% if config_update_error %}
        <div class="bg-red-100 border border-red-300 text-red-800 px-4 py-2 rounded mb-4">{{ config_update_error }}</div>
      {% endif %}
      {% if session.admin_logged_in %}
      <form method="post" class="space-y-4" id="config-form">
        {% for k, v in config_data.items() %}
          <div class="flex flex-col sm:flex-row sm:items-center gap-2 relative group items-center hover:bg-blue-50 dark:hover:bg-gray-700 rounded transition">
            <label class="font-semibold w-40 text-gray-700 dark:text-gray-200">{{ k }}</label>
            {% if k == 'config_version' %}
              <span class="flex-1 text-gray-500 dark:text-gray-300">{{ v }}</span>
            {% elif k == 'redis_enabled' or k == 'redis_host' or k == 'redis_port' %}
              {% if loop.first or not prev_redis %}<div class="flex-1 flex flex-col gap-1 bg-gray-50 dark:bg-gray-800 p-2 rounded border border-gray-200 dark:border-gray-700">
              <div class="font-semibold text-blue-700 dark:text-blue-300 mb-1 flex items-center gap-2"><i class="fa-solid fa-bolt"></i> Redis Config
                <button type="button" class="redis-config-btn text-gray-500 hover:text-blue-600 ml-2 opacity-0 group-hover:opacity-100 transition-opacity" title="Configure Redis"><i class="fa-solid fa-pen"></i></button>
              </div>{% set prev_redis=True %}{% endif %}
              <div class="flex items-center gap-2">
                <span class="text-gray-700 dark:text-gray-200">Host: {{ config_data.get('redis_host', 'localhost') }}</span>
                <span class="text-gray-700 dark:text-gray-200">Port: {{ config_data.get('redis_port', 6379) }}</span>
              </div>
              {% if loop.last or not (config_data.get('redis_enabled') or config_data.get('redis_host') or config_data.get('redis_port')) %}</div>{% set prev_redis=False %}{% endif %}
            {% elif k == 'log_level' %}
              <div class="flex-1 flex items-center gap-2">
                <div class="relative loglevel-dropdown-container w-48">
                  <input type="hidden" name="log_level" id="log_level_input" value="{{ v }}">
                  <button type="button" id="loglevel-btn" class="w-full flex items-center justify-between px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100 bg-white dark:bg-gray-900" aria-haspopup="listbox">
                    <span id="loglevel-selected" class="flex items-center gap-2">
                      <i class="fa-solid fa-bug loglevel-icon" style="color:#6b7280;"></i> DEBUG
                    </span>
                    <i class="fa-solid fa-chevron-down ml-2"></i>
                  </button>
                  <ul id="loglevel-list" class="absolute left-0 w-full bg-white dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded shadow-lg mt-1 z-50 hidden">
                    <li data-value="DEBUG" class="flex items-center gap-2 px-2 py-1 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 text-gray-700 dark:text-gray-100 bg-white dark:bg-gray-900"> <i class="fa-solid fa-bug loglevel-icon" style="color:#2563eb;"></i> DEBUG</li>
                    <li data-value="INFO" class="flex items-center gap-2 px-2 py-1 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 text-gray-700 dark:text-gray-100 bg-white dark:bg-gray-900"> <i class="fa-solid fa-info-circle loglevel-icon" style="color:#22c55e;"></i> INFO</li>
                    <li data-value="WARNING" class="flex items-center gap-2 px-2 py-1 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 text-gray-700 dark:text-gray-100 bg-white dark:bg-gray-900"> <i class="fa-solid fa-triangle-exclamation loglevel-icon" style="color:#eab308;"></i> WARNING</li>
                    <li data-value="ERROR" class="flex items-center gap-2 px-2 py-1 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 text-gray-700 dark:text-gray-100 bg-white dark:bg-gray-900"> <i class="fa-solid fa-circle-xmark loglevel-icon" style="color:#ef4444;"></i> ERROR</li>
                    <li data-value="CRITICAL" class="flex items-center gap-2 px-2 py-1 cursor-pointer hover:bg-blue-100 dark:hover:bg-blue-900 text-gray-700 dark:text-gray-100 bg-white dark:bg-gray-900"> <i class="fa-solid fa-skull-crossbones loglevel-icon" style="color:#a21caf;"></i> CRITICAL</li>
                  </ul>
                </div>
              </div>
            {% elif k == 'auto_redirect_delay' %}
              <div class="flex-1 flex items-center gap-2">
                <input name="auto_redirect_delay" type="number" min="0" step="1" value="{{ v }}" class="px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100 w-32" readonly />
                <span class="text-xs text-gray-500">seconds</span>
                <button type="button" class="edit-btn text-gray-500 hover:text-blue-600 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Edit"><i class="fa-solid fa-pen"></i></button>
              </div>
            {% elif k == 'port' %}
              <div class="flex-1 flex items-center gap-2">
                <input name="port" type="number" min="1" max="65535" value="{{ v }}" class="px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100 w-32" readonly />
                <button type="button" class="edit-btn text-gray-500 hover:text-blue-600 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Edit"><i class="fa-solid fa-pen"></i></button>
              </div>
            {% elif k == 'database' %}
              <div class="flex-1 flex items-center gap-2">
                <input name="database" type="text" value="{{ v }}" class="px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100 w-64" readonly id="db-input" />
                <button type="button" class="db-config-btn text-gray-500 hover:text-blue-600 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Configure database"><i class="fa-solid fa-database"></i></button>
              </div>
              <div class="w-full text-xs text-gray-400 ml-40">Configure SQLite, PostgreSQL, or MySQL. For SQLite, select a folder.</div>
            {% else %}
              <div class="flex-1 flex items-center gap-2">
                <input name="{{ k }}" value="{{ v }}" class="px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100" readonly />
                <button type="button" class="edit-btn text-gray-500 hover:text-blue-600 ml-1 opacity-0 group-hover:opacity-100 transition-opacity" title="Edit"><i class="fa-solid fa-pen"></i></button>
              </div>
            {% endif %}
          </div>
        {% endfor %}
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold shadow flex items-center gap-2"><i class="fa-solid fa-save"></i> Save Config</button>
      </form>

      <!-- Database config modal -->
      <div id="db-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
          <h3 class="text-lg font-bold mb-4 text-blue-700 dark:text-blue-200 flex items-center gap-2"><i class="fa-solid fa-database"></i> <span class="dark:text-blue-200">Database Configuration</span></h3>
          <div class="mb-4">
            <label class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Database Type</label>
            <select id="db-type" class="w-full px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100">
              <option value="sqlite">SQLite</option>
              <option value="postgresql">PostgreSQL</option>
              <option value="mysql">MySQL</option>
            </select>
          </div>
          <div id="sqlite-config" class="mb-4">
            <label class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">SQLite Folder</label>
            <div class="flex items-center gap-2">
              <input id="sqlite-folder" type="text" class="flex-1 px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100" readonly />
              <button type="button" id="choose-folder-btn" class="text-gray-500 hover:text-blue-600" title="Choose folder"><i class="fa-solid fa-folder-open"></i></button>
            </div>
            <div class="text-xs text-gray-400 dark:text-gray-300 mt-1">The file <b class="dark:text-blue-200">redirects.db</b> will be used in the selected folder.</div>
          </div>
          <div id="pg-config" class="mb-4 hidden relative">
            <div class="floating-label-group">
              <input id="pg-uri" type="text" class="w-full px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100 peer" placeholder=" " autocomplete="off" />
              <label for="pg-uri" class="floating-label text-gray-500 dark:text-gray-300">PostgreSQL URI (e.g. postgresql://user:pass@host:port/dbname)</label>
              <span id="pg-uri-status" class="absolute right-2 top-1/2 -translate-y-1/2 text-lg"></span>
            </div>
          </div>
          <div id="mysql-config" class="mb-4 hidden relative">
            <div class="floating-label-group">
              <input id="mysql-uri" type="text" class="w-full px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100 peer" placeholder=" " autocomplete="off" />
              <label for="mysql-uri" class="floating-label text-gray-500 dark:text-gray-300">MySQL URI (e.g. mysql://user:pass@host:port/dbname)</label>
              <span id="mysql-uri-status" class="absolute right-2 top-1/2 -translate-y-1/2 text-lg"></span>
            </div>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="db-cancel" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100">Cancel</button>
            <button type="button" id="db-save" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Save</button>
          </div>
        </div>
      </div>

      <!-- Redis config modal -->
      <div id="redis-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-md">
          <h3 class="text-lg font-bold mb-4 text-blue-700 dark:text-blue-200 flex items-center gap-2"><i class="fa-solid fa-bolt"></i> <span class="dark:text-blue-200">Redis Configuration</span></h3>
          <div class="mb-4">
            <label class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Host</label>
            <input id="redis-host" type="text" class="w-full px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100" value="{{ config_data.get('redis_host', 'localhost') }}" autocomplete="off" />
          </div>
          <div class="mb-4">
            <label class="block font-semibold mb-1 text-gray-700 dark:text-gray-200">Port</label>
            <input id="redis-port" type="number" min="1" max="65535" class="w-full px-2 py-1 rounded border border-gray-300 dark:bg-gray-900 dark:text-gray-100" value="{{ config_data.get('redis_port', 6379) }}" autocomplete="off" />
          </div>
          <div class="flex items-center gap-2 mb-4">
            <span id="redis-status-icon"></span>
            <span id="redis-status-msg" class="text-sm text-gray-700 dark:text-gray-200"></span>
          </div>
          <div class="flex justify-end gap-2">
            <button type="button" id="redis-cancel" class="px-4 py-2 rounded bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-100">Cancel</button>
            <button type="button" id="redis-save" class="px-4 py-2 rounded bg-blue-600 text-white font-semibold">Save</button>
          </div>
        </div>
      </div>

      <style>
      .floating-label-group {
        position: relative;
      }
      .floating-label {
        position: absolute;
        left: 12px;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        transition: 0.2s;
        background: transparent;
        padding: 0 2px;
      }
      .peer:focus ~ .floating-label,
      .peer:not(:placeholder-shown) ~ .floating-label {
        top: -0.7em;
        left: 8px;
        font-size: 0.85em;
        color: #2563eb;
        background: #fff;
        z-index: 10;
      }
      .dark .floating-label {
        background: #232946;
        color: #60a5fa;
      }
      </style>

      <script>
      // Per-field edit logic
      [...document.querySelectorAll('.edit-btn')].forEach(function(btn) {
        btn.addEventListener('click', function() {
          const parent = btn.closest('.flex-1');
          if (!parent) return;
          const input = parent.querySelector('input, select');
          if (!input) return;
          input.readOnly = false;
          input.disabled = false;
          input.focus();
          btn.classList.add('text-blue-600');
          // On blur, revert to read-only
          input.addEventListener('blur', function handler() {
            input.readOnly = true;
            input.disabled = true;
            btn.classList.remove('text-blue-600');
            input.removeEventListener('blur', handler);
          });
        });
      });
      // Log level dropdown logic
      const loglevelBtn = document.getElementById('loglevel-btn');
      const loglevelList = document.getElementById('loglevel-list');
      const loglevelInput = document.getElementById('log_level_input');
      const loglevelSelected = document.getElementById('loglevel-selected');
      if (loglevelBtn && loglevelList && loglevelInput && loglevelSelected) {
        // Set initial selected icon and text
        function setLogLevelSelected(val) {
          const item = loglevelList.querySelector(`li[data-value='${val}']`);
          if (item) {
            loglevelSelected.innerHTML = item.innerHTML;
          }
        }
        setLogLevelSelected(loglevelInput.value);
        loglevelBtn.addEventListener('click', function(e) {
          loglevelList.classList.toggle('hidden');
          e.stopPropagation();
        });
        loglevelList.querySelectorAll('li').forEach(function(item) {
          item.addEventListener('click', function() {
            loglevelInput.value = item.getAttribute('data-value');
            loglevelSelected.innerHTML = item.innerHTML;
            loglevelList.classList.add('hidden');
          });
        });
        document.addEventListener('click', function() {
          loglevelList.classList.add('hidden');
        });
      }
      // Add icons to log level dropdown (note: most browsers do not render HTML/icons in <option> elements)
      function decorateLogLevelDropdown() {
        // No-op: FontAwesome icons in <option> are not supported in most browsers.
        // The dropdown will show plain text, but the value is clear.
      }
      document.addEventListener('DOMContentLoaded', decorateLogLevelDropdown);
      </script>
      {% else %}
      <pre class="bg-gray-100 dark:bg-gray-900 rounded p-4 text-xs text-left overflow-x-auto text-gray-800 dark:text-blue-100 border border-blue-200 dark:border-blue-700" style="max-height: 350px;">
{{ config_data | tojson(indent=2) | safe | replace('"database": "' ~ config_data.get('database', '') ~ '"', '"database": "***hidden***"') | replace('"admin_password": "' ~ config_data.get('admin_password', '') ~ '"', '"admin_password": "***hidden***"') }}
</pre>
<div class="text-xs text-gray-400 dark:text-gray-500 mt-2">Login as admin to edit config. Sensitive fields (like passwords, database path) and upstreams are hidden. Use the dedicated page for upstreams.</div>
      {% endif %}
    </div>

    <a href="/" class="text-blue-600 dark:text-blue-400 hover:underline">← Back to Dashboard</a>
    <div class="mt-6 text-xs text-gray-500 dark:text-gray-400">
      <i class="fa-solid fa-circle-info mr-1"></i>
      <span>Theme preference is saved in your browser. Use the toggle in the header to switch dark/light mode.</span>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    // Optionally show feedback
  });
}
function parseBaseVersion(ver) {
  if (!ver) return '';
  let m = ver.match(/(\d+\.\d+\.\d+)/);
  return m ? m[1] : ver;
}
async function checkVersionPage() {
  const iconSpan = document.getElementById('version-status-icon');
  const versionSpan = document.getElementById('version-string');
  let current = versionSpan.textContent.trim();
  try {
    const resp = await fetch('/api/latest-version');
    const data = await resp.json();
    if (!data.success) throw new Error(data.error || 'Unknown error');
    const latest = data.latest;
    current = data.current || current;
    versionSpan.textContent = current;
    const baseCurrent = parseBaseVersion(current);
    const baseLatest = parseBaseVersion(latest);
    if (baseLatest && baseCurrent && baseLatest === baseCurrent) {
      iconSpan.innerHTML = '<i class="fa-solid fa-circle-check text-green-500" title="You are running the latest version (v' + current + ')."></i>';
    } else if (baseLatest && baseCurrent && baseLatest > baseCurrent) {
      iconSpan.innerHTML = '<i class="fa-solid fa-circle-exclamation text-yellow-400" title="A newer version (v' + latest + ') is available! You are running v' + current + '."></i>';
      showUpgradeNotice(latest, current);
    } else {
      iconSpan.innerHTML = '<i class="fa-solid fa-circle-question text-gray-400" title="Version status unknown. Current: v' + current + ', Latest: v' + latest + '"></i>';
    }
  } catch (e) {
    iconSpan.innerHTML = '<i class="fa-solid fa-circle-xmark text-red-500" title="Could not check for updates. Current version: v' + current + ' (' + e + ')"></i>';
    showUpgradeNotice(null, current, true);
  }
}
function showUpgradeNotice(latest, current, error) {
  let notice = document.getElementById('upgrade-notice');
  if (!notice) {
    notice = document.createElement('div');
    notice.id = 'upgrade-notice';
    notice.className = 'mt-4 p-3 rounded bg-yellow-100 dark:bg-yellow-900 text-yellow-800 dark:text-yellow-200 text-sm font-semibold flex items-center gap-2 justify-center';
    versionSpan = document.getElementById('version-string');
    versionSpan.parentNode.parentNode.insertBefore(notice, versionSpan.parentNode.nextSibling);
  }
  if (error) {
    notice.textContent = 'Could not check for updates. You are running v' + current + '.';
    notice.style.display = '';
  } else if (latest && latest !== current) {
    notice.textContent = `Upgrade available: v${latest} (You are running v${current})`;
    notice.style.display = '';
  } else {
    notice.style.display = 'none';
  }
}
checkVersionPage();
</script>
{% endblock %}

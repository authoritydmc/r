{% extends "base.html" %}
{% block title %}Check Upstreams - Real Time{% endblock %}
{% block content %}
<div class="max-w-xl mx-auto bg-white dark:bg-gray-800 rounded-lg shadow p-8 mt-8">
  <h2 class="text-2xl font-bold mb-4 text-blue-700 dark:text-blue-200">Checking Upstreams for <span class="font-mono">{{ pattern }}</span></h2>
  <div id="logbox" class="bg-gray-100 dark:bg-gray-900 border border-gray-300 dark:border-gray-700 rounded p-4 text-sm font-mono text-gray-700 dark:text-gray-200 mb-4" style="min-height:120px;">
    <b>Upstream Check Log:</b>
    <ul id="loglist" class="list-disc pl-6 mt-2"></ul>
  </div>
  <div id="resultbox" class="hidden"></div>
</div>
<script>
var pattern = {{ pattern|tojson}};
const loglist = document.getElementById('loglist');
const resultbox = document.getElementById('resultbox');
let found = false;
let redirected = false;
function addLog(msg) {
  let li = document.createElement('li');
  li.textContent = msg;
  loglist.appendChild(li);
  loglist.scrollTop = loglist.scrollHeight;
}
function showResult(msg, isError) {
  resultbox.className = isError
    ? 'bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded mb-4'
    : 'bg-green-100 border border-green-400 text-green-700 px-4 py-2 rounded mb-4';
  resultbox.innerHTML = msg;
  resultbox.classList.remove('hidden');
}
const evtSource = new EventSource(`/stream/check-upstreams/${encodeURIComponent(pattern)}`);
evtSource.onmessage = function(event) {
  const data = JSON.parse(event.data);
  if (data.log) addLog(data.log);
  if (data.found && data.redirect_url && !redirected) {
    showResult('<b>Shortcut exists in upstream!</b> Redirecting...', true);
    redirected = true;
    setTimeout(() => { window.location.href = data.redirect_url; }, 1800);
    evtSource.close();
  }
  if (data.done && !found) {
    showResult('<b>No upstream found. Redirecting to create/edit page...</b>', false);
    setTimeout(() => { window.location.href = `/edit/${encodeURIComponent(pattern)}`; }, 50000);
    evtSource.close();
  }
};
</script>
{% endblock %}

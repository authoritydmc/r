{% extends "base.html" %}
{% block title %}Upstream Logs - URL Shortener/Redirector{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto my-10 bg-white dark:bg-gray-900 rounded-lg shadow p-6">
  <h2 class="text-2xl font-bold mb-4 text-blue-700 dark:text-blue-300 flex items-center gap-2">
    <i class="fa-solid fa-list-alt"></i> Upstream Logs
  </h2>
  {% if logs and logs|length > 0 %}
    {% if logs[0] is mapping %}
      <div class="mb-4 flex items-center gap-2">
        <input type="text" id="log-search" placeholder="Search logs..." class="border border-gray-300 dark:border-gray-700 rounded px-3 py-2 w-full bg-white dark:bg-gray-800 text-gray-800 dark:text-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-400" />
        <i class="fa fa-search text-gray-400 dark:text-gray-300"></i>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead>
            <tr class="bg-blue-50 dark:bg-gray-800">
              <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200">Time</th>
              <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200">Shortcut</th>
              <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200">Upstream</th>
              <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200">Result</th>
              <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200">Status Code</th>
              <th class="px-3 py-2 text-left text-gray-700 dark:text-gray-200">Actual URL</th>
            </tr>
          </thead>
          <tbody id="logs-table-body">
            {% for log in logs %}
            {% set is_success = (log.result or '').lower() == 'success' %}
            {% set is_fail = (log.result or '').lower() in ['fail', 'exception'] %}
            {% set details = log.details or '' %}
            {% set status_code = details.split('status_code=')[1].split(',')[0].strip() if 'status_code=' in details else '-' %}
            {% set actual_url = details.split('actual_url=')[1].split(',')[0].strip() if 'actual_url=' in details else '-' %}
            <tr class="border-b border-gray-200 dark:border-gray-700 hover:bg-blue-50 dark:hover:bg-gray-800 {% if is_success %}bg-green-50 dark:bg-green-900/40{% elif is_fail %}bg-red-50 dark:bg-red-900/40{% endif %}">
              <td class="px-3 py-2 font-mono text-xs text-gray-800 dark:text-gray-100">{{ log.time or log.timestamp or '-' }}</td>
              <td class="px-3 py-2 font-mono text-gray-800 dark:text-gray-100">{{ log.shortcut or '-' }}</td>
              <td class="px-3 py-2 text-gray-800 dark:text-gray-100">{{ log.upstream or '-' }}</td>
              <td class="px-3 py-2 text-gray-800 dark:text-gray-100">{{ log.result or '-' }}</td>
              <td class="px-3 py-2 text-gray-800 dark:text-gray-100">{{ status_code }}</td>
              <td class="px-3 py-2 text-xs break-all text-blue-700 dark:text-blue-300 underline"><a href="{{ actual_url }}" target="_blank">{{ actual_url }}</a></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <script>
        // Quick search for logs table
        document.getElementById('log-search').addEventListener('input', function() {
          const q = this.value.toLowerCase();
          const rows = document.querySelectorAll('#logs-table-body tr');
          rows.forEach(row => {
            const text = row.innerText.toLowerCase();
            row.style.display = text.includes(q) ? '' : 'none';
          });
        });
      </script>
    {% else %}
      <div class="bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded p-4 max-h-96 overflow-y-auto text-xs text-gray-700 dark:text-gray-200">
        <ul class="space-y-1">
          {% for log in logs %}
            <li>{{ log }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  {% else %}
    <div class="text-gray-500 dark:text-gray-400">No upstream logs found.</div>
  {% endif %}
</div>
{% endblock %}
